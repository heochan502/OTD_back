<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.otd.onetoday_back.community.mapper.CommunityMapper">

    <!-- âœ… resultMap: DTOì™€ DB ì»¬ëŸ¼ ë§¤í•‘ -->
    <resultMap id="CommunityPostResMap" type="com.otd.onetoday_back.community.dto.CommunityPostRes">
        <id property="postId" column="post_id"/>
        <result property="memberNoLogin" column="member_no_login"/>
        <result property="memberNick" column="member_nick"/>
        <result property="memberImg" column="member_img"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="filePath" column="file_path"/>
        <result property="createdAt" column="created_at"/>
        <result property="viewCount" column="view_count"/>
        <result property="like" column="like"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="commentCount" column="comment_count"/> <!-- ðŸ’¬ ëŒ“ê¸€ ìˆ˜ -->
    </resultMap>

    <!-- ê²Œì‹œê¸€ ì €ìž¥ -->
    <insert id="save" parameterType="com.otd.onetoday_back.community.domain.Community"
            useGeneratedKeys="true" keyProperty="postId">
        INSERT INTO community_post (
        member_no_login, title, content, file_path,
        created_at, updated_at, view_count, `like`
        ) VALUES (
        #{memberNoLogin}, #{title}, #{content}, #{filePath},
        #{createdAt}, #{updatedAt}, #{viewCount}, #{like}
        )
    </insert>

    <!-- ê²Œì‹œê¸€ ì²¨ë¶€íŒŒì¼ ì €ìž¥ -->
    <insert id="saveFile" parameterType="com.otd.onetoday_back.community.domain.Community">
        INSERT INTO community_postfile (
        post_id, member_no_login, file_name, file_path, file_type, uploaded_at
        ) VALUES (
        #{postId}, #{memberNoLogin}, #{fileName}, #{filePath}, #{fileType}, #{uploadedAt}
        )
    </insert>

    <!-- ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ -->
    <select id="findAll" resultMap="CommunityPostResMap">
        SELECT
        p.post_id,
        p.member_no_login,
        m.member_nick,
        m.member_img,
        p.title,
        p.content,
        (
        SELECT f.file_path
        FROM community_postfile f
        WHERE f.post_id = p.post_id
        ORDER BY f.uploaded_at ASC
        LIMIT 1
        ) AS file_path,
        p.created_at,
        p.view_count,
        p.`like`,
        p.is_deleted,
        (
        SELECT COUNT(*)
        FROM community_comment c
        WHERE c.post_id = p.post_id
        ) AS comment_count
        FROM community_post p
        LEFT JOIN member m ON p.member_no_login = m.member_no_login
        <where>
            <if test="searchText != null and searchText != ''">
                (p.title LIKE CONCAT('%', #{searchText}, '%')
                OR p.content LIKE CONCAT('%', #{searchText}, '%'))
            </if>
        </where>
        ORDER BY p.post_id DESC
    </select>

    <!-- ìƒì„¸ ì¡°íšŒ -->
    <select id="findById" resultMap="CommunityPostResMap">
        SELECT
        p.post_id,
        p.member_no_login,
        m.member_nick,
        m.member_img,
        p.title,
        p.content,
        (
        SELECT f.file_path
        FROM community_postfile f
        WHERE f.post_id = p.post_id
        ORDER BY f.uploaded_at ASC
        LIMIT 1
        ) AS file_path,
        p.created_at,
        p.view_count,
        p.`like`,
        p.is_deleted,
        (
        SELECT COUNT(*)
        FROM community_comment c
        WHERE c.post_id = p.post_id
        ) AS comment_count
        FROM community_post p
        LEFT JOIN member m ON p.member_no_login = m.member_no_login
        WHERE p.post_id = #{postId}
        LIMIT 1
    </select>

    <!-- ê²Œì‹œê¸€ ìˆ˜ì • -->
    <update id="modify" parameterType="com.otd.onetoday_back.community.domain.Community">
        UPDATE community_post
        SET title = #{title},
        content = #{content},
        updated_at = #{updatedAt}
        WHERE post_id = #{postId}
    </update>

    <!-- ë…¼ë¦¬ ì‚­ì œ -->
    <update id="deleteById">
        UPDATE community_post
        SET is_deleted = TRUE
        WHERE post_id = #{postId}
    </update>

    <!-- ë‹¨ê±´ ì¡°íšŒ (í•„ìš” ì‹œ) -->
    <select id="findPostById" resultMap="CommunityPostResMap">
        SELECT *
        FROM community_post
        WHERE post_id = #{postId}
    </select>

    <!-- ì‚­ì œ ì•ˆ ëœ ê²Œì‹œê¸€ ëª©ë¡ -->
    <select id="selectPosts" resultMap="CommunityPostResMap">
        SELECT
        p.post_id,
        p.member_no_login,
        p.title,
        p.content,
        p.file_path,
        p.created_at,
        p.view_count,
        p.`like`,
        p.is_deleted,
        (
        SELECT COUNT(*)
        FROM community_comment c
        WHERE c.post_id = p.post_id
        ) AS comment_count
        FROM community_post p
        WHERE p.is_deleted = FALSE
        ORDER BY p.created_at DESC
    </select>

    <!-- ëŒ“ê¸€ ì €ìž¥ -->
    <insert id="saveComment" parameterType="com.otd.onetoday_back.community.dto.MentReq">
        INSERT INTO community_comment (
        post_id, member_no_login, content, updated_at
        ) VALUES (
        #{postId}, #{memberNoLogin}, #{content}, #{updatedAt}
        )
    </insert>

    <!-- ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ (ìµœì‹ ì´ ì•„ëž˜: ASC ì •ë ¬ ê¶Œìž¥ ì‹œ ASCë¡œ ë³€ê²½ ê°€ëŠ¥) -->
    <select id="findCommentsByPostId" resultType="com.otd.onetoday_back.community.dto.MentRes">
        SELECT
        c.comment_id,
        c.post_id,
        c.member_no_login,
        m.member_nick,
        m.member_img,
        c.content,
        c.updated_at
        FROM community_comment c
        LEFT JOIN member m ON c.member_no_login = m.member_no_login
        WHERE c.post_id = #{postId}
        ORDER BY c.updated_at DESC
    </select>

    <!-- íŽ˜ì´ì§• í¬í•¨ ëª©ë¡ -->
    <select id="findAllWithPaging" resultMap="CommunityPostResMap">
        SELECT
        p.post_id,
        p.member_no_login,
        m.member_nick,
        m.member_img,
        p.title,
        p.content,
        (
        SELECT f.file_path
        FROM community_postfile f
        WHERE f.post_id = p.post_id
        ORDER BY f.uploaded_at ASC
        LIMIT 1
        ) AS file_path,
        p.created_at,
        p.view_count,
        p.`like`,
        p.is_deleted,
        (
        SELECT COUNT(*)
        FROM community_comment c
        WHERE c.post_id = p.post_id
        ) AS comment_count
        FROM community_post p
        LEFT JOIN member m ON p.member_no_login = m.member_no_login
        <where>
            p.is_deleted = FALSE
            <if test="searchText != null and searchText != ''">
                AND (p.title LIKE CONCAT('%', #{searchText}, '%')
                OR p.content LIKE CONCAT('%', #{searchText}, '%'))
            </if>
        </where>
        ORDER BY p.post_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ -->
    <update id="updateLikeCount">
        UPDATE community_post
        SET `like` = #{likeCount}
        WHERE post_id = #{postId}
    </update>

    <!-- ì´ ê°œìˆ˜ -->
    <select id="countAll" resultType="int">
        SELECT COUNT(*)
        FROM community_post
        WHERE is_deleted = FALSE
        <if test="searchText != null and searchText != ''">
            AND (title LIKE CONCAT('%', #{searchText}, '%')
            OR content LIKE CONCAT('%', #{searchText}, '%'))
        </if>
    </select>

</mapper>
